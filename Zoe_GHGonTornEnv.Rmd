---
title: "Zoe_GHGonTornEnv"
author: "Zoe Schroder and Heidi Erfourth"
date: "2023-07-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

Journal of Climate Dynamics (no APC charges Apply!)
https://www.springer.com/journal/382/how-to-publish-with-us#Fees%20and%20Funding 

Projections you may need: 
```{r}
merc <- "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
US_LCC <- "+proj=lcc +lat_1=33 +lat_2=45 +lat_0=39 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs"
```

Coordinate Reference Systems you may need:
https://spatialreference.org/ref/esri/usa-contiguous-lambert-conformal-conic/
```{r}
WGS84 <- 4326
```

Install the packages for this project: 
```{r}
suppressMessages(library(sf))
suppressMessages(library(dplyr))
suppressMessages(library(lubridate))
suppressMessages(library(lutz))
suppressMessages(library(xts))
suppressMessages(library(chron))
suppressMessages(library(sp))
suppressMessages(library(USAboundaries))
suppressMessages(library(tmap))
suppressMessages(library(raster))
suppressMessages(library(ggplot2))
suppressMessages(library(gridExtra))
```

Load the outbreak data for this project: 
```{r}
load("TornadoOutbreaks.RData")
```

Extract the information for the second largest big day (December 15, 2021):

```{r}
Dec15 <- BigDays.sfdfT %>%
  dplyr::filter(ID == "202112156918")

Dec15Centroid <- BigDayCentroids.df %>%
  dplyr::filter(ID == "202112156918")

Dec15Torns <- BigDayTornadoes %>%
  dplyr::filter(ID == "202112156918")
```

## Example Big Day: Plot the big day of December 15, 2021

Step 1: Get the state data for the lower 48 using the `us_states` function from the **USAboundaries** package. This will allow the state borders to be added to a map using the *tm_shape* function. 
```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
```

Step 2: Plot the December 15, 2021 big day.
```{r}
tm_shape(stateBorders) +
  tm_borders(col = "gray70", 
             alpha = 1) +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") +       
  tm_scale_bar(width = .3, 
               text.size = 0.8, 
               lwd = 1.75, 
               color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.15, .15, .1, .1)) + # (S, W, N, E)
#Plot the hull of the outbreak
tm_shape(Dec15,
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
    tm_polygons(alpha = 0,
                border.col = "black",
                lwd = 1.5) +
#Plot the individual tornadoes
tm_shape(Dec15Torns, 
         is.master = TRUE, 
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
    tm_bubbles(size = 0.5, 
              col = "mag", 
              breaks = seq(0, 5, by=1),
              labels = c("F1", "F2", "F3", "F4", "F5"), 
              title.col = "Magnitude") +
      tm_layout(title = "December 15, 2021 \n 125 Tornadoes", 
                legend.title.size = 1.1,
                legend.position = c("right", "bottom"), 
                legend.stack = "horizontal",
                legend.frame = FALSE, 
                legend.text.size = 1, legend.width = -0.15) +
# Plot the central location of the outbreaks
tm_shape(Dec15Centroid, 
         is.master = TRUE, 
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_symbols(size = 1.25, 
             col = "black", 
             shape = 24) 
```

```{r}
cat <- c()
for(i in 1:dim(BigDays.sfdfT)[1]) {
  x <- ifelse(BigDays.sfdfT$nT[i] < 30, '10 - 29',
                          ifelse(BigDays.sfdfT$nT[i] >= 30 && BigDays.sfdfT$nT[i] < 60, '30 - 59', 
                          ifelse(BigDays.sfdfT$nT[i] >= 60 && BigDays.sfdfT$nT[i] < 90, '60 - 89', 
                          ifelse(BigDays.sfdfT$nT[i] >= 90, '90+',0))))
  cat <- c(cat, x)
}

Categories <-  as.data.frame(cat)

MakeTab <- cbind(BigDays.sfdfT, Categories) 
x <- MakeTab %>%
  group_by(cat) %>%
  summarize(numClus = n(),
            numCas = sum(GroupDayCas),
            numTorns = sum(nT))
x
```

## Tornado Outbreak Density by County: 

Step 1: Get the counties data. 
```{r}
counties.sf <- us_counties()

#Set the coordinate reference system:
counties.sf <- st_transform(counties.sf, 
                            crs = st_crs(BigDays.sfdfT))
```

Step 2: Count how many times each outbreak crosses/Intersects a county in the contiguous United States. 
```{r}
gI <- st_intersects(BigDays.sfdfT, counties.sf, sparse = FALSE)
colnames(gI) <- counties.sf$name
counties.sf$GroupDayCount <- colSums(gI)
```

Step 3: Remove Alaska, Hawaii, and Puerto Rico from the `states.sf` data frame.
```{r}
states.sf <- stateBorders %>% 
  filter(!stusps %in% c("AK", "PR", "HI"))
```

Create a map of the outbreak density in each county in the United States. Fill by the `GroupDayCount` column. 
```{r}
counties.sf <- st_transform(counties.sf, 
                            crs = st_crs(stateBorders))
BigDays.sfdfT <- st_transform(BigDays.sfdfT, 
                            crs = st_crs(stateBorders))

merc <- "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
US_LCC <- "+proj=lcc +lat_1=33 +lat_2=45 +lat_0=39 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs"

tm_shape(BigDays.sfdfT) +
  tm_polygons(alpha = 0, border.alpha = 0) +
tm_shape(counties.sf) +
   tm_fill("GroupDayCount",
            title = "Total Outbreaks",
            palette = "Purples", breaks = c(0, 20, 40, 60, 80, 100, 120)) +
  tm_borders(col = "gray", alpha = .0) +
  tm_compass(size = 5, position = c("left", "bottom"), color.dark = "gray70") + tm_scale_bar(width = 0.4, size = 1.4, color.dark = "gray70") +
  tm_layout(legend.position = c("right", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE,
                   #title = "Tornado Outbreaks by County [1994-2022]",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
                   inner.margins = c(.15, .01, .01, .01),
            legend.width = -0.2, 
            legend.height = -0.3, 
            legend.title.size=1.5,
            legend.text.size = 1.25,
            legend.bg.color = "white",
            legend.bg.alpha =1) +
tm_shape(stateBorders, is.master = TRUE, projection = merc) +
  tm_borders() 
```
** Big day density by county **

Number of times each county was within the convex hull of a big tornado day (more than 10 tornadoes occurring in an'outbreak', 1994-2022).

## Example NARR: December 15, 2021

```{r}
BigDays.sfdfT %>%
  group_by(NARRZtime) %>%
  summarize(numClus = n(), 
            numTorns = sum(nT))
```


Step 1: Read in the raster.
```{r, eval=FALSE}
#December 15, 2021
i = 839
  rb <- brick(paste0("E:/NCARNARR/All/", BigDays.sfdfT$slug2[i], "/",BigDays.sfdfT$slug[i])) #<-- this is for varying NARR times
  CAPE <- raster(rb, layer = 375)
  HLCY <- raster(rb, layer = 323)
  CIN <- raster(rb, layer = 376)
  UGRD500 <- raster(rb, layer = 117) 
  VGRD500 <- raster(rb, layer = 118) 
  UGRD850 <- raster(rb, layer = 206) 
  VGRD850 <- raster(rb, layer = 207)
  UGRDsfc <- raster(rb, layer = 293) 
  VGRDsfc <- raster(rb, layer = 294)     
  DLBS <- sqrt(((UGRD500 - UGRDsfc)**2) + ((VGRD500 - VGRDsfc)**2))
  SLBS <- sqrt(((UGRD850 - UGRDsfc)**2) + ((VGRD850 - VGRDsfc)**2))
```

Step 2: Plot the figures for CAPE, CIN, DLBS, & SLBS

**Convective Available Potential energy **
```{r, eval=FALSE}
#CAPE = projectRaster(CAPE, crs = "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
Dec15 <- st_transform(Dec15, 
  crs = "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
CAPE_Dec15 <- crop(CAPE, extent(Dec15))
CAPE_extent<- mask(CAPE_Dec15, Dec15)
#plot(CAPE_extent)

maxCAPE <- which.max(CAPE_extent) #Returns a pixel number

#Test that this max value equals the one in BigDays.sfdfT
test <- getValues(CAPE_extent) 
test<-as.matrix(test, ncol=1)
```

```{r, eval=FALSE}
CAPEmaxpos <- xyFromCell(CAPE_extent, maxCAPE)

xy <- data.frame(CAPEmaxpos)
CAPE_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CAPE_latlon)

CAPE_latlon <- SpatialPoints(CAPE_latlon)
proj4string(CAPE_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p1 <- tm_shape(CAPE_extent) +
  tm_raster(title = "",  
            n = 6, 
            palette = "BuPu") +
  tm_format(title = expression(paste("Convective Available Potential Energy [J ", kg^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.2, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
  #tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CAPE_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p1
```

**Convective Inhibition**
```{r, eval=FALSE}
CIN_Dec15 <- crop(CIN, extent(Dec15))
CIN_extent<- mask(CIN_Dec15, Dec15)
#plot(CIN_extent)

minCIN <- which.min(CIN_extent) #Returns a pixel number

#Test that this max value equals the one in BigDays.sfdfT
test <- getValues(CIN_extent) 
test<-as.matrix(test, ncol=1)
```

```{r, eval=FALSE}
CINmaxpos <- xyFromCell(CIN_extent, minCIN)

xy <- data.frame(CINmaxpos)
CIN_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CIN_latlon)

CIN_latlon <- SpatialPoints(CIN_latlon)
proj4string(CIN_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p2 <- tm_shape(CIN_extent) +
  tm_raster(title = "",  
            n = 6, 
            palette = "Greens") +
  tm_format(title = expression(paste("Convective Inhibition [J ",kg^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.2, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
  #tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CIN_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p2
```

**Shallow-Layer Bulk Shear**
```{r, eval=FALSE}
SLBS_Dec15 <- crop(SLBS, extent(Dec15))
SLBS_extent<- mask(SLBS_Dec15, Dec15)
#plot(SLBS_extent)

maxSLBS <- which.max(SLBS_extent)
```

```{r, eval=FALSE}
SLBSmaxpos <- xyFromCell(SLBS_extent, maxSLBS)

xy <- data.frame(SLBSmaxpos)
SLBS_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(SLBS_latlon)

SLBS_latlon <- SpatialPoints(SLBS_latlon)
proj4string(SLBS_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p3 <- tm_shape(SLBS_extent) +
  tm_raster(title = "", 
            n = 5, 
            palette = "Blues") +
  tm_format(title = expression(paste("Shallow-Layer Bulk Shear [m ",s^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
  #tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ", s^-1, "]")), "World", legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.15, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
tm_shape(SLBS_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p3
```

**Deep-Layer Bulk Shear**
```{r, eval=FALSE}
DLBS_Dec15 <- crop(DLBS, extent(Dec15))
DLBS_extent<- mask(DLBS_Dec15, Dec15)
#plot(DLBS_extent)

maxDLBS <- which.max(DLBS_extent)
```

```{r, eval=FALSE}
DLBSmaxpos <- xyFromCell(DLBS_extent, maxDLBS)

xy <- data.frame(DLBSmaxpos)
DLBS_latlon <- data.frame(lon=xy$x, 
                          lat=xy$y)
print(DLBS_latlon)

DLBS_latlon <- SpatialPoints(DLBS_latlon)
proj4string(DLBS_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p4 <- tm_shape(DLBS_extent) +
  tm_raster(title = "", 
            n = 5, 
            palette = "Reds") +
  tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ",s^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
  #tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ", s^-1, "]")), "World", legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.15, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
tm_shape(DLBS_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p4
```

Step 3: Combine into one figure.
```{r, eval=FALSE}
tmap_arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)
```

## Plot the GHG Emissions from 1994 to 2022:

Step 1: Load in the Greenhouse Gas Data
```{r}
GHG_Emissions <- read.csv("AnnualAverages_GHG.csv")
GHG_Emissions$Year <- GHG_Emissions$Ã¯..year
```

The colors for GHG values in all of the following plots are:
CO2: "blue"
CH4: "purple3"
O3: "goldenrod"
"red4"
"deeppink"
AGGI: "green4"

Step 2: Plot line graphs of the Emission Data. Emission values on the `y` axis and year on the `x` axis. 

Carbon Dioxide: 
```{r}
CO2_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = Year, y = CO2_ppm), 
            color = "blue", lwd = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Carbon Dioxide Emissions (ppm)") +
   theme(axis.text.x = element_text(angle=45, 
                                    hjust=1, 
                                    size = 14),
         axis.text.y = element_text(size = 14), 
         axis.title.x = element_text(size = 16),
         axis.title.y = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1979, 2023), 
                     breaks = seq(1980, 2023, 5)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(300, 430), 
                     breaks = seq(300, 425, 25)) 

CO2_plot
```

Methane: 
```{r}
CH4_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = Year, y = CH4_ppb), 
            color = "purple3",
            lwd = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Methane Emissions (ppb)") +
  theme(axis.text.x = element_text(angle=45, 
                                    hjust=1, 
                                    size = 14),
         axis.text.y = element_text(size = 14), 
         axis.title.x = element_text(size = 16),
         axis.title.y = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1979, 2023), 
                     breaks = seq(1980, 2023, 5)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(1550, 2010), 
                     breaks = seq(1550, 2000, 50)) 

CH4_plot
```

Ozone:
```{r}
O3_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = Year, y = O3_DU), 
            color = "goldenrod",
            lwd = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Ozone Emissions (DU)") +
   theme(axis.text.x = element_text(angle=45, 
                                    hjust=1, 
                                    size = 14),
         axis.text.y = element_text(size = 14), 
         axis.title.x = element_text(size = 16),
         axis.title.y = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1979, 2023), 
                     breaks = seq(1980, 2023, 5)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(80, 245), 
                     breaks = seq(80, 240, 20)) 

O3_plot
```

```{r}
p3 <- ggplot(GHG_Emissions, 
      aes(x= Year, y=SF6_ppt))+
   geom_line(stat="identity", 
             color = "red2",
             lwd = 2)+
   theme_bw() +
   theme(axis.text.x = element_text(angle=45, 
                                    hjust=1, 
                                    size = 14),
         axis.text.y = element_text(size = 14), 
         axis.title.x = element_text(size = 16),
         axis.title.y = element_text(size = 16)) +
   ylab(expression("Sulfur Hexafluoride (in ppt)")) +
   xlab("Year") +
   scale_x_continuous(expand = c(0, 0), 
                     limits=c(1979, 2023), 
                     breaks = seq(1980, 2023, 5)) + 
   scale_y_continuous(expand = c(0,0), 
                     limits = c(0, 12), 
                     breaks = seq(0, 12, 2)) 

p3
```

```{r}
p4 <- ggplot(GHG_Emissions, 
      aes(x= Year, y=N2O_ppb))+
   geom_line(stat="identity", 
             color = "deeppink",
             lwd = 2)+
   theme_bw() +
   theme(axis.text.x = element_text(angle=45, 
                                    hjust=1, 
                                    size = 14),
         axis.text.y = element_text(size = 14), 
         axis.title.x = element_text(size = 16),
         axis.title.y = element_text(size = 16)) +
   ylab(expression("Nitrous Oxide (in ppb)")) +
   xlab("Year") +
   scale_x_continuous(expand = c(0, 0), 
                     limits=c(1979, 2023), 
                     breaks = seq(1980, 2023, 5)) + 
   scale_y_continuous(expand = c(0,0), 
                     limits = c(300, 340), 
                     breaks = seq(300, 340, 5)) 

p4
```

Annual Greenhouse Gas Index:
```{r}
AGGI_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = Year, y = AGGI), 
            color = "green4",
            lwd = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Annual Greenhouse Gas Index") +
   theme(axis.text.x = element_text(angle=45, 
                                    hjust=1, 
                                    size = 14),
         axis.text.y = element_text(size = 14), 
         axis.title.x = element_text(size = 16),
         axis.title.y = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1979, 2023), 
                     breaks = seq(1980, 2023, 5)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0.6, 1.63), 
                     breaks = seq(0.7, 1.6, 0.1)) 

AGGI_plot
```

Step 3: Make the 2x2 grid panel of the emission values.
```{r}
grid.arrange(CO2_plot, CH4_plot, p3, p4, O3_plot, AGGI_plot, nrow = 2)
```
`Fig_GHGEmissionsData`

## Plot the 10-year average GHG values with the maximum (minimum for CIN) environmental variables for outbreaks with at least ten tornadoes.

Step 1: Sort the data by year and extract the max/min values for the environmental variables and max values of the 10-year average GHG values. 
```{r}
x <- BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(max_CAPE = max(maxCAPE),
            min_CIN = min(minCIN),
            max_DLBS = max(maxBS_deep),
            max_SLBS = max(maxBS_shallow),
            CO2 = max(CO2_10year), #red
            CH4 = max(CH4_10year),#green
            O3 = max(O3_10year), #purple
            AGGI = max(AGGI_10year)) #yellow
```

Step 2: Make a figure for each environmental variable (CAPE, CIN, DLBS, SLBS) with a trend line for each GHG variable (CO2, CH4, O3, AGGI).

CAPE and CO2 (10-year):
```{r}
p1 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "grey70",
           lwd = 1) +
  geom_line(aes(x = Year, y = CO2*7000/500),
            stat = "identity",
            color = "blue",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*500/7000, 
                                         name = "Carbon Dioxide [ppm]"))
```

CAPE and CH4 (10-year)
```{r}
p2 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = CH4*6000/1900),
            stat = "identity",
            color = "green3",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*1900/6000, 
                                         name = "Methane [ppb]"))
```

CAPE and Ozone (10-year):
```{r}
p3 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = O3*6000/140),
            stat = "identity",
            color = "purple3",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*140/6000, 
                                         name = "Ozone [DU]"))
```

CAPE and AGGI: 
```{r}
p4 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = AGGI*6000/1.5),
            stat = "identity",
            color = "yellow3",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*1.5/6000, 
                                         name = "Annual Greenhouse Gas Index"))
```

Step 3: Merge the figures above into a single 2x2 panel figure:
```{r}
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

## Check for Collinearity between the GHG variables: 

# Install and activate the package

```{r}
#install.packages("corrplot")
library(corrplot)
```

```{r}
ModelData <- BigDays.sfdfT %>%
  dplyr::select(maxCAPE, 
                maxBS_deep, 
                maxBS_shallow, 
                CO2_10year,
                CH4_10year, 
                O3_10year,
                AGGI_10year)

colnames(ModelData) <- c("CAPE", "DLBS", "SLBS", "CO2", "CH4", "O3", "AGGI", "geometry")

ModelData <- as.data.frame(ModelData)
ModelData <- ModelData[1:7]

cordat <- cor(ModelData)

corrplot(cordat, 
         method="number", 
         col = COL1("YlOrRd",200),
         type = "lower", 
         tl.col="black",
         col.lim = c(-1,1))
```

The Models:

Distributions of the response variables: 

`CAPE`
```{r}
plot_CAPE <- ggplot(BigDays.sfdfT, aes(maxCAPE)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,7000)) +
  #scale_x_log10() + 
  xlab(expression(paste("Maximum CAPE [J ", kg^-1, "]"))) +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50, 60, 70), labels = c("0", "10", "20", "30", "40", "50", "60", "70"), limits = c(0, 70)) +
  ylab("Number of Clusters") + 
  ggtitle("C") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

`Deep Layer Shear`
```{r}
plot_DLBS <- ggplot(BigDays.sfdfT, aes(maxBS_deep)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,50)) +
  #scale_x_log10() + 
  xlab(expression(paste("Maximum Deep Layer Bulk Shear [m ", s^-1, "]"))) +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50, 60, 70), labels = c("0", "10", "20", "30", "40", "50", "60", "70"), limits = c(0, 70)) +
  ylab("Number of Clusters") + 
  ggtitle("A") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))

plot_DLBS
```

`Shallow Layer Shear`
```{r}
plot_SLBS <- ggplot(BigDays.sfdfT, aes(maxBS_shallow)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,40)) +
  #scale_x_log10() + 
  xlab(expression(paste("Maximum Shallow Layer Bulk Shear [m ", s^-1, "]"))) +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50, 60, 70), labels = c("0", "10", "20", "30", "40", "50", "60", "70"), limits = c(0, 70)) +
  ylab("Number of Clusters") + 
  ggtitle("B") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))

plot_SLBS
```

```{r}
library(corrplot)
library(ggpubr)
ggarrange(plot_DLBS, plot_SLBS, plot_CAPE, ncol = 1, nrow = 3)
```

Does collinearity exist between the explanatory variables?:

*What is the correlation between the GHG variables? *
```{r}
GHGVars <- data.frame(CO2 =  BigDays.sfdfT$CO2_10year, 
                       CH4 = BigDays.sfdfT$CH4_10year, 
                       O3 = BigDays.sfdfT$O3_10year, 
                       SF6 = BigDays.sfdfT$SF6_10year, 
                       N2O = BigDays.sfdfT$N2O_10year, 
                       AGGI = BigDays.sfdfT$AGGI_10year)
```

*Create a figure to show correlations between the climate variables. *
```{r}
corrplot.mixed(cor(GHGVars), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

```{r}
DLBS_env <- data.frame(CO2 =  BigDays.sfdfT$CO2_10year, 
                       O3 = BigDays.sfdfT$O3_10year, 
                       Lat = BigDays.sfdfT$Lat, 
                       Lon = BigDays.sfdfT$Lon, 
                       DLBS = BigDays.sfdfT$maxBS_deep)


corrplot.mixed(cor(DLBS_env), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

Initial Model:
```{r}
DLBS_m1 <- lm(maxBS_deep ~ CO2_1year + O3_10year + Lat + Lon + Year, data = BigDays.sfdfT)
summary(DLBS_m1)
```

Seasonal Trend:
```{r}
DLBSByMonth <- BigDays.sfdfT %>% 
  group_by(Mo) %>%
  summarize(nC = n(),
            avgDLBS = mean(maxBS_deep)/nC) 
```

`Make a figure of the Mean DLBS from 1994 to 2020 by month`
```{r}
ggplot(DLBSByMonth, aes(x = as.factor(Mo), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p0 <- ggplot(DLBSByMonth, aes(x = Mo, y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
 scale_x_continuous(breaks = seq(1, 12, 1), labels = month.abb) +
  scale_y_continuous(limits = c(0, 2)) +
  coord_polar(start =0) +
  labs(x = "Month", y = expression(paste("Normalized Averages of DLBS [m ", s^-1, "]"))) +
  #ggtitle("a") +
  theme_minimal() )
```

```{r}
BigDays.sfdfT$Hour_UTC <-  format(as.POSIXct(strptime(BigDays.sfdfT$StartTime_UTC,"%Y-%m-%d %H:%M:%S",tz="")) ,format = "%H")
```


Diurnal Trend:
```{r}
DLBSByHour <- BigDays.sfdfT %>% 
  group_by(Hour_UTC) %>%
  summarize(nC = n(),
            avgDLBS = mean(maxBS_deep))
```

`Make a figure of the total tornadoes from 1994 to 2018 by Hour`
```{r}
ggplot(DLBSByHour, aes(x = as.factor(Hour_UTC), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p1 <- ggplot(DLBSByHour, aes(x = as.factor(Hour_UTC), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 40)) +
  coord_polar(start =-0.2) +
  labs(x = "Hour (UTC)", y = expression(paste("Averaged Extremes of DLBS [m ", s^-1, "]"))) +
  theme_minimal() )
```

```{r}
ggarrange(p0, p1)
```

Annual Trend: 
```{r}
DLBSByYear <- BigDays.sfdfT %>% 
  group_by(Year) %>%
  summarize(avgDLBS = mean(maxBS_deep)) 
```

`Make a figure of the total tornadoes from 1994 to 2018 by Year`
```{r}
ggplot(DLBSByYear, aes(x = as.factor(Year), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( px <- ggplot(DLBSByYear, aes(x = as.factor(Year), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 40)) +
  coord_polar(start =-0.2) +
  labs(x = "Year", y = expression(paste("Averaged Extremes of DLBS [m ", s^-1, "]"))) +
  theme_minimal() )
```

```{r}
#Average Environmental Variable per year as the response variable? 
test <- BigDays.sfdfT %>%
  group_by(Year, Month) %>%
  summarize(avgmaxCAPE = mean(maxCAPE),
            avgmaxDLBS = mean(maxBS_deep),
            avgmaxSLBS = mean(maxBS_shallow),
            CO2_decadal = max(CO2_10year),
            CO2_annual = max(CO2_1year),
            CH4_decadal = max(CH4_10year),
            CH4_annual = max(CH4_1year),
            O3_decadal = max(O3_10year),
            O3_annual = max(O3_1year))
```


```{r}
library(lme4)
DLBS_m2 <- lmer(maxBS_deep ~ CO2_1year +O3_10year + Lat + Lon + (1|Month), data = BigDays.sfdfT)
summary(DLBS_m2)
```

```{r}
DLBS_m3 <- lmer(maxBS_deep ~ CO2_1year +O3_10year + Lat + Lon + (1|Month), data = BigDays.sfdfT)
summary(DLBS_m3)
```

```{r}
AIC(DLBS_m1, DLBS_m2, DLBS_m3)
```

*The lowest AIC is the model to choose!*
```{r}
DLBS_model <- DLBS_m4
```

*Check the residuals of model 8 of DLBS.*
```{r}
plot(residuals(DLBS_model)) 
```
There is no relationship between the residuals.

*Make a plot of the standardized residuals for the DLBS model*
```{r}
DLBSmod.df <- fortify.merMod(model=DLBS_model, data = nlme::getData(DLBS_model))
DLBSmod.df$predDLBS <- predict(DLBS_model)

pa <- ggplot(DLBSmod.df, aes(x = .scresid)) +
  geom_histogram(binwidth = .5, color = "white", fill = "gray40") +
  xlab("Standardized Residual") + ylab("Frequency") +
  ggtitle("A") +
  theme_minimal() + theme(text = element_text(size=15))

pb <- ggplot(DLBSmod.df, aes(x = .fitted, y = .scresid, color = factor(Mo))) +
         geom_point(size = 2) +
        # scale_x_log10() +
         scale_color_discrete(name = "Month") +
  xlab(expression(paste("DLBS [m ", s^-1, "]"))) + ylab("Standardized Residual") +
  ggtitle("B") +
  theme_minimal() + theme(text = element_text(size=15))
grid.arrange(pa, pb, ncol = 2)
```
Conditional standardized residuals from the linear regression model. (A) Histogram and (B) Residuals as a function of predicted values of DLBS. The pattern in B indicates that predictions for larger values of DLBS are less accurate. 

*How does the model do compared to the actual values? *
```{r}
predictDLBS <- predict(DLBS_model)
BigDays.sfdfT$predDLBS <- predictDLBS

cor.test(BigDays.sfdfT$maxBS_deep, predictDLBS, conf.level = 0.95)
MuMIn::r.squaredGLMM(DLBS_model)
library("sjstats")
r2(DLBS_model)
```
This model explains 36% of the variation of DLBS.

*Make a table of the model coefficients. *
```{r}
DLBSmod_coefs <- summary(DLBS_model)
xtable(DLBSmod_coefs$coefficients, digits = 3)
```

*What are the confidence intervals for the model? *
```{r}
confint(DLBS_model)
```

*Plot the observed vs Predicted values of DLBS*
```{r}
BigDays.sfdfT$Month.name <- factor(BigDays.sfdfT$Month, labels = month.name)
mypalette <- brewer.pal(name = "Blues", n =9)
mypalette <- mypalette[3:6]
DLBSobspred <- ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxBS_deep, 
                 y = predDLBS), #col = Month), 
             color = "#2171B5",
            # color.palette = "Blues",
             size = 5, 
             show.legend = FALSE,  
             stroke = 0, 
             alpha = 0.6) +
  scale_color_brewer(palette = "Blues") +
  geom_smooth(method = "lm", data = BigDays.sfdfT,
            aes(x = maxBS_deep, 
                 y = predDLBS), 
            color = "Blue", 
            size = 1.25, 
            se = FALSE, 
            fullrange = TRUE) +
      #scale_colour_continuous(type = "viridis", guide = guide_colorbar(reverse = TRUE)) +
  #  facet_wrap(~Month.name, ncol = 3, labeller = label_value) +

  geom_abline(slope = 1, 
              size = 1.25,
              col = "black") + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 50)) +
  ylab(expression(paste("Estimated DLBS [m ", s^-1, "]"))) + 
      xlab(expression(paste("Observed DLBS [m ", s^-1, "]"))) +
     theme_bw() + 
      theme(text = element_text(size=15), strip.background = element_rect(size = 0.5), panel.border=element_rect(colour="black",size=1), panel.background=element_rect(fill="white"), axis.text.x = element_text(angle = 45, hjust = 1)) 

DLBSobspred
```
