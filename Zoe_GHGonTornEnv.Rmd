---
title: "Zoe_GHGonTornEnv"
author: "Zoe Schroder and Heidi Erfourth"
date: "2023-07-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

Journal of Climate Dynamics (no APC charges Apply!)
https://www.springer.com/journal/382/how-to-publish-with-us#Fees%20and%20Funding 

Projections you may need: 
```{r}
merc <- "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
US_LCC <- "+proj=lcc +lat_1=33 +lat_2=45 +lat_0=39 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs"
```

Coordinate Reference Systems you may need:
https://spatialreference.org/ref/esri/usa-contiguous-lambert-conformal-conic/
```{r}
WGS84 <- 4326
```

Install the packages for this project: 
```{r}
suppressMessages(library(sf))
suppressMessages(library(dplyr))
suppressMessages(library(lubridate))
suppressMessages(library(lutz))
suppressMessages(library(xts))
suppressMessages(library(chron))
suppressMessages(library(sp))
suppressMessages(library(USAboundaries))
suppressMessages(library(tmap))
suppressMessages(library(raster))
suppressMessages(library(ggplot2))
suppressMessages(library(gridExtra))
```

Load the outbreak data for this project: 
```{r}
load("TornadoOutbreaks.RData")
```

Extract the information for the second largest big day (December 15, 2021):

```{r}
Dec15 <- BigDays.sfdfT %>%
  dplyr::filter(ID == "202112156918")

Dec15Centroid <- BigDayCentroids.df %>%
  dplyr::filter(ID == "202112156918")

Dec15Torns <- BigDayTornadoes %>%
  dplyr::filter(ID == "202112156918")
```

## Example Big Day: Plot the big day of December 15, 2021

Step 1: Get the state data for the lower 48 using the `us_states` function from the **USAboundaries** package. This will allow the state borders to be added to a map using the *tm_shape* function. 
```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
```

Step 2: Plot the December 15, 2021 big day.
```{r}
tm_shape(stateBorders) +
  tm_borders(col = "gray70", 
             alpha = 1) +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") +       
  tm_scale_bar(width = .3, 
               text.size = 0.8, 
               lwd = 1.75, 
               color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.15, .15, .1, .1)) + # (S, W, N, E)
#Plot the hull of the outbreak
tm_shape(Dec15,
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
    tm_polygons(alpha = 0,
                border.col = "black",
                lwd = 1.5) +
#Plot the individual tornadoes
tm_shape(Dec15Torns, 
         is.master = TRUE, 
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
    tm_bubbles(size = 0.5, 
              col = "mag", 
              breaks = seq(0, 5, by=1),
              labels = c("F1", "F2", "F3", "F4", "F5"), 
              title.col = "Magnitude") +
      tm_layout(title = "December 15, 2021 \n 125 Tornadoes", 
                legend.title.size = 1.1,
                legend.position = c("right", "bottom"), 
                legend.stack = "horizontal",
                legend.frame = FALSE, 
                legend.text.size = 1, legend.width = -0.15) +
# Plot the central location of the outbreaks
tm_shape(Dec15Centroid, 
         is.master = TRUE, 
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_symbols(size = 1.25, 
             col = "black", 
             shape = 24) 
```

```{r}
cat <- c()
for(i in 1:dim(BigDays.sfdfT)[1]) {
  x <- ifelse(BigDays.sfdfT$nT[i] < 30, '10 - 29',
                          ifelse(BigDays.sfdfT$nT[i] >= 30 && BigDays.sfdfT$nT[i] < 60, '30 - 59', 
                          ifelse(BigDays.sfdfT$nT[i] >= 60 && BigDays.sfdfT$nT[i] < 90, '60 - 89', 
                          ifelse(BigDays.sfdfT$nT[i] >= 90, '90+',0))))
  cat <- c(cat, x)
}

Categories <-  as.data.frame(cat)

MakeTab <- cbind(BigDays.sfdfT, Categories) 
x <- MakeTab %>%
  group_by(cat) %>%
  summarize(numClus = n(),
            numCas = sum(GroupDayCas),
            numTorns = sum(nT))
x
```

## Tornado Outbreak Density by County: 

Step 1: Get the counties data. 
```{r}
counties.sf <- us_counties()

#Set the coordinate reference system:
counties.sf <- st_transform(counties.sf, 
                            crs = st_crs(BigDays.sfdfT))
```

Step 2: Count how many times each outbreak crosses/Intersects a county in the contiguous United States. 
```{r}
gI <- st_intersects(BigDays.sfdfT, counties.sf, sparse = FALSE)
colnames(gI) <- counties.sf$name
counties.sf$GroupDayCount <- colSums(gI)
```

Step 3: Remove Alaska, Hawaii, and Puerto Rico from the `states.sf` data frame.
```{r}
states.sf <- stateBorders %>% 
  filter(!stusps %in% c("AK", "PR", "HI"))
```

Create a map of the outbreak density in each county in the United States. Fill by the `GroupDayCount` column. 
```{r}
counties.sf <- st_transform(counties.sf, 
                            crs = st_crs(stateBorders))
BigDays.sfdfT <- st_transform(BigDays.sfdfT, 
                            crs = st_crs(stateBorders))

merc <- "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
US_LCC <- "+proj=lcc +lat_1=33 +lat_2=45 +lat_0=39 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs"

tm_shape(BigDays.sfdfT) +
  tm_polygons(alpha = 0, border.alpha = 0) +
tm_shape(counties.sf) +
   tm_fill("GroupDayCount",
            title = "Total Outbreaks",
            palette = "Reds", breaks = c(0, 20, 40, 60, 80, 100, 120)) +
  tm_borders(col = "gray", alpha = .3) +
  tm_compass(size = 5, position = c("left", "bottom")) + tm_scale_bar(width = 0.4, size = 1.4) +
  tm_layout(legend.position = c("right", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE,
                   #title = "Tornado Outbreaks by County [1994-2022]",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
                   inner.margins = c(.15, .01, .01, .01),
            legend.width = -0.2, 
            legend.height = -0.3, 
            legend.title.size=1.5,
            legend.text.size = 1.25,
            legend.bg.color = "white",
            legend.bg.alpha =1) +
tm_shape(stateBorders, is.master = TRUE, projection = merc) +
  tm_borders() 
```
** Big day density by county **

Number of times each county was within the convex hull of a big tornado day (more than 10 tornadoes occurring in an'outbreak', 1994-2022).

## Example NARR: December 15, 2021

```{r}
BigDays.sfdfT %>%
  group_by(NARRZtime) %>%
  summarize(numClus = n(), 
            numTorns = sum(nT))
```


Step 1: Read in the raster.
```{r, eval=FALSE}
#December 15, 2021
i = 839
  rb <- brick(paste0("E:/NCARNARR/All/", BigDays.sfdfT$slug2[i], "/",BigDays.sfdfT$slug[i])) #<-- this is for varying NARR times
  CAPE <- raster(rb, layer = 375)
  HLCY <- raster(rb, layer = 323)
  CIN <- raster(rb, layer = 376)
  UGRD500 <- raster(rb, layer = 117) 
  VGRD500 <- raster(rb, layer = 118) 
  UGRD850 <- raster(rb, layer = 206) 
  VGRD850 <- raster(rb, layer = 207)
  UGRDsfc <- raster(rb, layer = 293) 
  VGRDsfc <- raster(rb, layer = 294)     
  DLBS <- sqrt(((UGRD500 - UGRDsfc)**2) + ((VGRD500 - VGRDsfc)**2))
  SLBS <- sqrt(((UGRD850 - UGRDsfc)**2) + ((VGRD850 - VGRDsfc)**2))
```

Step 2: Plot the figures for CAPE, CIN, DLBS, & SLBS

**Convective Available Potential energy **
```{r, eval=FALSE}
#CAPE = projectRaster(CAPE, crs = "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
Dec15 <- st_transform(Dec15, 
  crs = "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
CAPE_Dec15 <- crop(CAPE, extent(Dec15))
CAPE_extent<- mask(CAPE_Dec15, Dec15)
#plot(CAPE_extent)

maxCAPE <- which.max(CAPE_extent) #Returns a pixel number

#Test that this max value equals the one in BigDays.sfdfT
test <- getValues(CAPE_extent) 
test<-as.matrix(test, ncol=1)
```

```{r, eval=FALSE}
CAPEmaxpos <- xyFromCell(CAPE_extent, maxCAPE)

xy <- data.frame(CAPEmaxpos)
CAPE_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CAPE_latlon)

CAPE_latlon <- SpatialPoints(CAPE_latlon)
proj4string(CAPE_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p1 <- tm_shape(CAPE_extent) +
  tm_raster(title = "",  
            n = 6, 
            palette = "BuPu") +
  tm_format(title = expression(paste("Convective Available Potential Energy [J ", kg^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.2, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
  #tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CAPE_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p1
```

**Convective Inhibition**
```{r, eval=FALSE}
CIN_Dec15 <- crop(CIN, extent(Dec15))
CIN_extent<- mask(CIN_Dec15, Dec15)
#plot(CIN_extent)

minCIN <- which.min(CIN_extent) #Returns a pixel number

#Test that this max value equals the one in BigDays.sfdfT
test <- getValues(CIN_extent) 
test<-as.matrix(test, ncol=1)
```

```{r, eval=FALSE}
CINmaxpos <- xyFromCell(CIN_extent, minCIN)

xy <- data.frame(CINmaxpos)
CIN_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CIN_latlon)

CIN_latlon <- SpatialPoints(CIN_latlon)
proj4string(CIN_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p2 <- tm_shape(CIN_extent) +
  tm_raster(title = "",  
            n = 6, 
            palette = "Greens") +
  tm_format(title = expression(paste("Convective Inhibition [J ",kg^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.2, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
  #tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CIN_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p2
```

**Shallow-Layer Bulk Shear**
```{r, eval=FALSE}
SLBS_Dec15 <- crop(SLBS, extent(Dec15))
SLBS_extent<- mask(SLBS_Dec15, Dec15)
#plot(SLBS_extent)

maxSLBS <- which.max(SLBS_extent)
```

```{r, eval=FALSE}
SLBSmaxpos <- xyFromCell(SLBS_extent, maxSLBS)

xy <- data.frame(SLBSmaxpos)
SLBS_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(SLBS_latlon)

SLBS_latlon <- SpatialPoints(SLBS_latlon)
proj4string(SLBS_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p3 <- tm_shape(SLBS_extent) +
  tm_raster(title = "", 
            n = 5, 
            palette = "Blues") +
  tm_format(title = expression(paste("Shallow-Layer Bulk Shear [m ",s^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
  #tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ", s^-1, "]")), "World", legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.15, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
tm_shape(SLBS_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p3
```

**Deep-Layer Bulk Shear**
```{r, eval=FALSE}
DLBS_Dec15 <- crop(DLBS, extent(Dec15))
DLBS_extent<- mask(DLBS_Dec15, Dec15)
#plot(DLBS_extent)

maxDLBS <- which.max(DLBS_extent)
```

```{r, eval=FALSE}
DLBSmaxpos <- xyFromCell(DLBS_extent, maxDLBS)

xy <- data.frame(DLBSmaxpos)
DLBS_latlon <- data.frame(lon=xy$x, 
                          lat=xy$y)
print(DLBS_latlon)

DLBS_latlon <- SpatialPoints(DLBS_latlon)
proj4string(DLBS_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r, eval=FALSE}
p4 <- tm_shape(DLBS_extent) +
  tm_raster(title = "", 
            n = 5, 
            palette = "Reds") +
  tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ",s^-1,"]")), 
            "World", 
            legend.position = c("right", "bottom"),
  #tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ", s^-1, "]")), "World", legend.position = c("right", "bottom"),
            attr.position = c("right", "top"),
            legend.frame = FALSE,
            inner.margins = c(.15, 0.05, .15, .1), #bottom, left, top
            legend.text.size = 1, 
            legend.width = -0.15, 
            legend.title.size=1, 
            legend.bg.color = "white", 
            title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, 
               text.size = 0.8, 
               position = c("left", "bottom"), 
               color.dark = "gray70") +
  tm_compass(size = 3, 
             text.size = 1, 
             lwd = 2, 
             color.dark = "gray70") + 
tm_shape(stateBorders) +
  tm_borders() +
tm_shape(Dec15, 
         is.master = TRUE, 
         projection = merc) +
  tm_borders(col = "black", 
             lwd = 3)  +
tm_shape(DLBS_latlon) + 
  tm_symbols(size = 1.4, 
             col = "black", 
             shape = 22)
p4
```

Step 3: Combine into one figure.
```{r, eval=FALSE}
tmap_arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)
```

## Plot the GHG Emissions from 1994 to 2022:

Step 1: Load in the Greenhouse Gas Data
```{r}
GHG_Emissions <- read.csv("AnnualAverages_GHG.csv")
```

The colors for GHG values in all of the following plots are:
CO2: "red"
CH4: "green3"
O3: "purple3"
AGGI: "yellow3"

Step 2: Plot line graphs of the Emission Data. Emission values on the `y` axis and year on the `x` axis. 

Carbon Dioxide: 
```{r}
CO2_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = year, y = CO2_ppm), 
            color = "red",
            linewidth = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Carbon Dioxide Emissions (ppm)") +
  theme(axis.text = element_text(size = 14), 
        axis.title = element_text(size = 16), 
        legend.text = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1959, 2023), 
                     breaks = seq(1960, 2023, 10)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(300, 430), 
                     breaks = seq(300, 425, 25)) 

CO2_plot
```

Methane: 
```{r}
CH4_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = year, y = CH4_ppb), 
            color = "green3",
            linewidth = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Methane Emissions (ppb)") +
  theme(axis.text = element_text(size = 14), 
        axis.title = element_text(size = 16), 
        legend.text = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1960, 2023), 
                     breaks = seq(1960, 2023, 10)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(1600, 2010), 
                     breaks = seq(1600, 2000, 50)) 

CH4_plot
```

Ozone:
```{r}
O3_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = year, y = O3_DU), 
            color = "purple3",
            linewidth = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Ozone Emissions (DU)") +
  theme(axis.text = element_text(size = 14), 
        axis.title = element_text(size = 16), 
        legend.text = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1960, 2023), 
                     breaks = seq(1960, 2023, 10)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(80, 245), 
                     breaks = seq(80, 240, 20)) 

O3_plot
```

Annual Greenhouse Gas Index:
```{r}
AGGI_plot <- ggplot(GHG_Emissions) +
  geom_line(aes(x = year, y = AGGI), 
            color = "yellow3",
            linewidth = 2) +
  theme_bw() +
  xlab("Year") +
  ylab("Annual Greenhouse Gas Index") +
  theme(axis.text = element_text(size = 14), 
        axis.title = element_text(size = 16), 
        legend.text = element_text(size = 16)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1960, 2023), 
                     breaks = seq(1960, 2023, 10)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0.6, 1.63), 
                     breaks = seq(0.7, 1.6, 0.1)) 

AGGI_plot
```

Step 3: Make the 2x2 grid panel of the emission values.
```{r}
grid.arrange(CO2_plot, CH4_plot, O3_plot, AGGI_plot, nrow = 2)
```

## Plot the 10-year average GHG values with the maximum (minimum for CIN) environmental variables for outbreaks with at least ten tornadoes.

Step 1: Sort the data by year and extract the max/min values for the environmental variables and max values of the 10-year average GHG values. 
```{r}
x <- BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(max_CAPE = max(maxCAPE),
            min_CIN = min(minCIN),
            max_DLBS = max(maxBS_deep),
            max_SLBS = max(maxBS_shallow),
            CO2 = max(CO2_10year), #red
            CH4 = max(CH4_10year),#green
            O3 = max(O3_10year), #purple
            AGGI = max(AGGI_10year)) #yellow
```

Step 2: Make a figure for each environmental variable (CAPE, CIN, DLBS, SLBS) with a trend line for each GHG variable (CO2, CH4, O3, AGGI).

CAPE and CO2 (10-year):
```{r}
p1 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = CO2*7000/500),
            stat = "identity",
            color = "red",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*500/7000, 
                                         name = "Carbon Dioxide [ppm]"))
```

CAPE and CH4 (10-year)
```{r}
p2 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = CH4*6000/1900),
            stat = "identity",
            color = "green3",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*1900/6000, 
                                         name = "Methane [ppb]"))
```

CAPE and Ozone (10-year):
```{r}
p3 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = O3*6000/140),
            stat = "identity",
            color = "purple3",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*140/6000, 
                                         name = "Ozone [DU]"))
```

CAPE and AGGI: 
```{r}
p4 <- ggplot(x) +
  geom_bar(aes(x = Year, y = max_CAPE),
           stat = "identity", 
           color = "white",
           fill = "blue",
           linewidth = 1) +
  geom_line(aes(x = Year, y = AGGI*6000/1.5),
            stat = "identity",
            color = "yellow3",
            size = 2) +
  theme_bw() +
  xlab("Year") +
  ylab(expression(paste("Convective Available Potential Energy [J ",kg^-1,"]"))) +
  theme(axis.text = element_text(size = 12), 
        axis.text.x = element_text(angle = 45, 
                                   vjust = 1, 
                                   hjust = 1),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14)) +
  scale_x_continuous(expand = c(0, 0), 
                     limits=c(1993.5, 2022.5), 
                     breaks = seq(1994, 2022, 2)) + 
  scale_y_continuous(expand = c(0, 0), 
                     limits=c(0, 7100), 
                     breaks = seq(0, 7000, 1000),
                     sec.axis = sec_axis(~.*1.5/6000, 
                                         name = "Annual Greenhouse Gas Index"))
```

Step 3: Merge the figures above into a single 2x2 panel figure:
```{r}
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

## Check for Collinearity between the GHG variables: 

# Install and activate the package

```{r}
#install.packages("corrplot")
 
```

```{r}
ModelData <- BigDays.sfdfT %>%
  dplyr::select(nT, 
                GroupDayCas, 
                maxCAPE,
                minCIN,
                maxBS_deep, 
                maxBS_shallow, 
                CO2_10year,
                CH4_10year, 
                O3_10year,
                AGGI_10year,
                Lat,
                Lon,
                HullArea,
                totalPOP,
                Year)

colnames(ModelData) <- c("Torn", "Cas", "CAPE", "CIN", "DLBS", "SLBS", "CO2", "CH4", "O3", "AGGI", "Lat", "Lon", "Area", "Pop", "Year", "geometry")
ModelData <- as.data.frame(ModelData)
ModelData <- ModelData[1:15]
cordat <- cor(ModelData)
corrplot(cordat, method="number", type = "lower", tl.col="black")
```

